# 🧩 DataFrame 到 Excel 格式化函数 — 概念与设计文档  
**作者：** Horizon Yuan  
**版本：** v0.1（概念阶段）  
**最后更新：** 2025-10-12  

---

## 📘 1. 项目概述

本项目旨在设计一个基于 **Python 的通用格式化函数**，用于将任意 **pandas DataFrame** 转换为具有样式化的 Excel 输出。  

与标准的 `.to_excel()` 导出不同，本系统将提供一个灵活的 **格式配置层（formatting configuration layer）**，使开发者能够控制 Excel 中 **每一列、每一行、每一个单元格** 的显示方式，重点在于 **清晰性、模块化与可定制性**。

该项目将成为更大格式化框架的基础，其核心思想是：**样式定义与逻辑分离**。数据逻辑保持简洁，而 Excel 的外观可通过外部字典或 JSON 模板来控制。

---

## 🧠 2. 核心设计理念

### 🎯 设计目标
构建一个 **功能性强且可扩展** 的系统，能够：
- 将 **DataFrame 的列数据类型** 映射为 Excel 的显示格式；
- 在 **单元格级别** 应用自定义样式（字体、字号、颜色、背景等）；
- 可选地定义 **工作表级别属性**（如边框控制等）。

### 🔍 核心原则
> “数据定义结构，配置定义样式。”

本项目的目标 **不是** 处理复杂可视化（例如冻结窗格或条件格式），而是建立一个 **稳健且可复用的流水线系统**，定义原始 DataFrame 在导出到 Excel 时的显示样式。

---

## 🧩 3. 功能架构概览

### (1) 输入组件
| 组件 | 说明 |
|------|------|
| `DataFrame` | 源数据表。 |
| `style_dict` | 定义列、单元格和工作表格式规则的字典或 JSON 文件。 |
| `output_path` | 输出 Excel 文件路径或名称。 |

### (2) 处理流程
1. **读取** 样式定义（来自字典或 JSON）；  
2. **映射** 每列数据类型到目标 Excel 显示格式；  
3. **应用** 字体与颜色设置到指定单元格；  
4. **渲染** 样式化的 DataFrame 并输出为 Excel 文件（通过 openpyxl/xlsxwriter 实现）。  

---

## 🧱 4. 格式化逻辑结构

### 🧩 (a) 列级格式化
每一列将根据其 **数据类型** 重新格式化为对应的 Excel 显示格式。

| 数据类型 | Excel 格式 | 示例输出 |
|----------|-------------|----------|
| 浮点型 | `0.00` | `1234.56` |
| 整型 | `0` | `1234` |
| 日期 | `yyyy-mm-dd` | `2025-10-12` |
| 字符串 | 文本，左对齐 | `示例文本` |

---

### 🧩 (b) 单元格级格式化
单元格级样式可完全自定义，包括：
- 字体大小  
- 加粗或普通  
- 字体颜色  
- 背景颜色  
- 是否加边框  

示例定义：
```python
"cells": {
    (0, 0): {"font_size": 14, "bold": True, "bg_color": "#D6EAF8"},
    (1, 2): {"font_color": "#FF0000", "font_size": 11},
    (2, 3): {"bg_color": "#F9EBEA", "bold": False}
}
```

---

### 🧩 (c) 工作表级设置
- 全局边框控制  
- 工作表标题或名称自定义  
- 未来扩展：网格线可见性、单元格对齐方式等  

示例：
```python
"sheet": {
    "border": True,
    "title": "投资组合风险报告"
}
```

---

### 📋 样式字典完整示例
```python
style_dict = {
    "columns": {
        "A": {"type": "float", "format": "0.00"},
        "B": {"type": "date", "format": "yyyy-mm-dd"},
        "C": {"type": "string"}
    },
    "cells": {
        (0, 0): {"font_size": 14, "bold": True, "bg_color": "#AED6F1"},
        (1, 1): {"font_color": "#FF0000"},
        (2, 3): {"bg_color": "#FADBD8", "border": True}
    },
    "sheet": {
        "border": True
    }
}
```

---

## ⚙️ 5. 实现计划

### (a) 库选择
| 库 | 理由 |
|----|------|
| **openpyxl** | 适用于逐单元格后处理与样式编辑。 |
| **pandas** | 用于 DataFrame 处理与初步写入。 |
| **xlsxwriter** | 在处理大文件时可作为性能替代方案。 |

---

### (b) 核心类设计

```python
class ExcelFormatter:
    """
    将 DataFrame 转换为带样式的 Excel 文件。
    """

    def __init__(self, style_config: dict):
        self.style_config = style_config

    def apply_column_format(self, worksheet):
        """应用列级格式化规则。"""
        pass

    def apply_cell_format(self, worksheet):
        """应用单元格级样式（字体、颜色、背景等）。"""
        pass

    def export(self, df, output_path: str):
        """结合所有格式并导出 Excel 文件。"""
        pass
```

---

## 📦 6. 参考项目（设计灵感来源）

| 项目 | 描述 | 关键启示 |
|------|------|----------|
| **StyleFrame** | 将 pandas 与 openpyxl 结合，实现单元格级样式控制。 | 借鉴其样式抽象与列映射结构。 |
| **XlsxPandasFormatter** | 提供分层格式化 API。 | 学习列/行/单元格样式的优先级应用逻辑。 |
| **Pandabook** | 支持多工作表导出与样式模板。 | 借鉴模板复用机制。 |
| **copy_xlsx_styles** | 支持复制工作表样式。 | 有助于未来模板化扩展。 |

---

## 🎯 7. 当前阶段目标（里程碑 v0.1）

| 模块 | 功能 | 状态 |
|------|------|------|
| **列级格式化** | DataFrame 类型 → Excel 显示格式 | 🟢 已规划 |
| **单元格格式化** | 字体、加粗、颜色、背景色 | 🟢 已规划 |
| **工作表级样式** | 边框开关 | 🟢 已规划 |
| **导出功能** | 输出单 DataFrame → Excel | 🟢 已规划 |
| **测试** | 通过 openpyxl 样式属性验证 | 🔜 待执行 |

---

## 🔮 8. 后续扩展方向（Milestone v0.2+）
- 条件格式化规则  
- 基于 JSON 的样式模板  
- 列宽自适应计算  
- 支持多 DataFrame 多工作表导出  
- 合并单元格 / 标题行功能  
- 与前端 UI（Flask / Vue Dashboard）集成  

---

## 💬 9. 通用项目提示（用于文档或 AI 辅助续写）

> **项目摘要：**  
>  
> 设计一个 Python 模块，将 pandas DataFrame 转换为具可定制样式的 Excel 文件。  
>  
> 项目应支持通过字典或 JSON 配置，在三个层级定义样式规则：  
> - **列级** → 将数据类型映射为 Excel 格式。  
> - **单元格级** → 控制字体大小、加粗、颜色与背景。  
> - **工作表级** → 控制边框与全局样式规则。  
>  
> 本阶段重点在于构建轻量、可重用、可扩展的格式化流水线。  
>  
> 后续版本将引入条件格式、样式模板与样式继承机制。

---

## 📈 10. 进度总结

- ✅ 概念与结构设计完成  
- ✅ 样式字典结构确定  
- ✅ 技术路线（openpyxl）确定  
- ✅ 参考项目分析完成  
- 🔜 下一步：实现类与核心逻辑  
- 🔜 测试样例：对 5×5 DataFrame 进行导出验证  

---

**📅 下一里程碑：**  
实现并测试 `ExcelFormatter.export()`，在小型 DataFrame（5×5）上验证列与单元格样式是否正确应用。
