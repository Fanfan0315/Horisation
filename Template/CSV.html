{# Template/CSV.html #}
{% extends "Home.html" %}

{% block title %}Horisation - CSV Workspace{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/hormemo.css') }}">
<style>
  .csv-workspace { margin-top: 1rem; display: grid; gap: 1.5rem; }

  /* 上传区域 */
  .upload-section { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .upload-area {
    border: 2px dashed #d1d5db;
    padding: 2.5rem;
    text-align: center;
    border-radius: 12px;
    transition: all 0.3s;
    background: #f9fafb;
  }
  .upload-area.dragover { background: #eff6ff; border-color: #3b82f6; }
  .upload-area:hover { border-color: #9ca3af; }
  .upload-icon { font-size: 3rem; color: #6b7280; margin-bottom: 1rem; }

  /* 控制面板 */
  .control-panel {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .control-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .control-item label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.25rem;
    color: #374151;
    font-size: 0.875rem;
  }
  .control-item input, .control-item select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
  }

  .control-item textarea {
    width: 100%;
    min-height: 140px;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    font-family: "SFMono-Regular", "Menlo", "Consolas", "Liberation Mono", monospace;
    line-height: 1.5;
    resize: vertical;
  }

  .control-item.full-width {
    grid-column: 1 / -1;
  }

  .panel-section {
    margin-top: 1.75rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
  }

  .panel-section:first-of-type {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  /* 按钮组 */
  .action-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  .btn {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-primary { background: #3b82f6; color: white; }
  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
  .btn-secondary { background: #10b981; color: white; }
  .btn-secondary:hover { background: #059669; transform: translateY(-1px); }
  .btn-outline { background: white; color: #6b7280; border: 1px solid #d1d5db; }
  .btn-outline:hover { background: #f3f4f6; }
  .btn-warning { background: #f59e0b; color: white; }
  .btn-warning:hover { background: #d97706; transform: translateY(-1px); }
  .btn-danger { background: #ef4444; color: white; }
  .btn-danger:hover { background: #dc2626; transform: translateY(-1px); }

  .btn-group-inline {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .helper-text {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.5rem;
    line-height: 1.4;
  }

  .diff-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
  }

  .file-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
    font-size: 0.75rem;
    margin-top: 0.5rem;
  }

  .diff-status { margin-top: 1rem; }

  .created-files {
    margin-top: 0.75rem;
    padding-left: 1.25rem;
    color: #1f2937;
    font-size: 0.875rem;
  }

  .created-files li { margin: 0.25rem 0; }

  /* 结果展示区 */
  .result-section { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .result-tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 1rem;
  }
  .tab {
    padding: 0.75rem 1.25rem;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #6b7280;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  .tab.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
  }
  .tab:hover { color: #3b82f6; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* 列标签 */
  .column-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
  }
  .chip {
    padding: 0.375rem 0.75rem;
    border-radius: 999px;
    background: #eff6ff;
    color: #1e40af;
    font-size: 0.875rem;
    font-weight: 500;
  }
  .chip.numeric { background: #d1fae5; color: #065f46; }
  .chip.date { background: #fef3c7; color: #92400e; }

  /* 表格 */
  .table-container {
    overflow: auto;
    max-height: 500px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }
  table.data-table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.875rem;
  }
  table.data-table th {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    font-weight: 600;
    text-align: left;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  table.data-table td {
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
  }
  table.data-table tr:hover { background: #f9fafb; }

  /* 状态提示 */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
  }
  .status-success { background: #d1fae5; color: #065f46; }
  .status-error { background: #fee2e2; color: #991b1b; }
  .status-info { background: #dbeafe; color: #1e40af; }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }
  .summary-card {
    background: #f9fafb;
    padding: 1rem;
    border-radius: 8px;
  }
  .summary-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
  }
  .summary-label {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .muted { color: #6b7280; }
  .error-text { color: #dc2626; }
</style>
{% endblock %}

{% block content %}
<div class="content">
  <div class="dashboard-header">
    <h2><i class="fas fa-file-csv"></i> CSV 工作区</h2>
    <p>上传 CSV/Excel 文件，预览数据，执行清洗操作</p>
  </div>

  <div class="csv-workspace">
    <!-- 上传区域 -->
    <div class="upload-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;"><i class="fas fa-cloud-upload"></i> 文件上传</h3>
        <button id="btnChoose" class="btn btn-primary">
          <i class="fas fa-folder-open"></i> 选择文件
        </button>
        <input id="fileInput" type="file" accept=".csv,.xls,.xlsx" hidden>
      </div>

      <div id="dropzone" class="upload-area">
        <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
        <h4 style="margin: 0.5rem 0;">拖放文件到此处或点击选择</h4>
        <p class="muted">支持 CSV / Excel（.xls/.xlsx），最大 100MB</p>
        <div id="fileName" class="status-badge status-info" style="display: none; margin-top: 1rem;"></div>
      </div>
    </div>

    <!-- 控制面板 -->    <div class="control-panel">
      <h3><i class="fas fa-sliders-h"></i> 选项配置</h3>
      <div class="panel-section">
        <div class="control-grid">
          <div class="control-item">
            <label for="encodingSelect">编码 / Encoding</label>
            <select id="encodingSelect">
              <option value="">自动检测</option>
              <option value="utf-8">UTF-8</option>
              <option value="utf-8-sig">UTF-8 BOM</option>
              <option value="gbk">GBK</option>
              <option value="gb2312">GB2312</option>
              <option value="big5">Big5</option>
            </select>
          </div>

          <div class="control-item">
            <label for="separatorInput">分隔符 / Separator</label>
            <input id="separatorInput" type="text" value="," placeholder=", 或 ;">
          </div>

          <div class="control-item">
            <label for="rowsN">预览行数</label>
            <input id="rowsN" type="number" min="1" max="2000" value="10">
          </div>

          <div class="control-item">
            <label for="caseSelect">列名大小写</label>
            <select id="caseSelect">
              <option value="upper">大写 (UPPER)</option>
              <option value="lower">小写 (lower)</option>
              <option value="title">标题 (Title)</option>
            </select>
          </div>
        </div>

        <div class="action-buttons">
          <button id="btnPreview" class="btn btn-primary">
            <i class="fas fa-eye"></i> 预览数据
          </button>
          <button id="btnSummary" class="btn btn-secondary">
            <i class="fas fa-chart-bar"></i> 数据概要
          </button>
          <button id="btnClean" class="btn btn-outline">
            <i class="fas fa-broom"></i> 清洗数据
          </button>
        </div>

        <div id="statusMessage" style="margin-top: 1rem;"></div>
      </div>

      <div class="panel-section">
        <div class="section-header">
          <h4 style="margin: 0;"><i class="fas fa-magic"></i> 格式化 (Format)</h4>
          <div class="btn-group-inline">
            <button id="btnFormat" class="btn btn-secondary">
              <i class="fas fa-wand-magic-sparkles"></i> 应用格式化
            </button>
          </div>
        </div>
        <div class="control-item full-width">
          <label for="formatMappingInput">格式化映射配置（JSON 数组）</label>
          <textarea id="formatMappingInput" placeholder='例如: \n[\n  {"Column": ["Amount"], "trans_type": "float"},\n  {"Column": ["OrderDate"], "trans_type": "date", "format": "YYYY-MM-DD"}\n]'></textarea>
          <div class="helper-text">每个对象描述一组列的转换规则，留空则仅返回原始文件的格式化预览（最多 500 行）。</div>
        </div>
      </div>

      <div class="panel-section">
        <div class="section-header">
          <h4 style="margin: 0;"><i class="fas fa-code-branch"></i> 差异对比 (Diff)</h4>
        </div>

        <div class="diff-grid">
          <div class="control-item">
            <label for="diffFile1Input">基准文件 File 1</label>
            <input id="diffFile1Input" type="file" accept=".csv,.xls,.xlsx">
            <div id="diffFile1Name" class="file-pill" style="display: none;"><i class="fas fa-file"></i><span></span></div>
          </div>

          <div class="control-item">
            <label for="diffFile2Input">对比文件 File 2</label>
            <input id="diffFile2Input" type="file" accept=".csv,.xls,.xlsx">
            <div id="diffFile2Name" class="file-pill" style="display: none;"><i class="fas fa-file"></i><span></span></div>
          </div>

          <div class="control-item">
            <label for="diffEncoding1">编码 (File 1)</label>
            <select id="diffEncoding1">
              <option value="">自动检测</option>
              <option value="utf-8">UTF-8</option>
              <option value="utf-8-sig">UTF-8 BOM</option>
              <option value="gbk">GBK</option>
              <option value="gb2312">GB2312</option>
              <option value="big5">Big5</option>
            </select>
          </div>

          <div class="control-item">
            <label for="diffEncoding2">编码 (File 2)</label>
            <select id="diffEncoding2">
              <option value="">自动检测</option>
              <option value="utf-8">UTF-8</option>
              <option value="utf-8-sig">UTF-8 BOM</option>
              <option value="gbk">GBK</option>
              <option value="gb2312">GB2312</option>
              <option value="big5">Big5</option>
            </select>
          </div>

          <div class="control-item">
            <label for="diffSeparator1">分隔符 (File 1)</label>
            <input id="diffSeparator1" type="text" placeholder=", 或 ;">
          </div>

          <div class="control-item">
            <label for="diffSeparator2">分隔符 (File 2)</label>
            <input id="diffSeparator2" type="text" placeholder=", 或 ;">
          </div>
        </div>

        <div class="control-item full-width" style="margin-top: 1rem;">
          <label for="diffMappingInput">差异映射配置（必填，JSON 数组）</label>
          <textarea id="diffMappingInput" placeholder='例如: \n[\n  {"out_file": "diff_highlight.xlsx", "suffix1": "old", "suffix2": "new"},\n  {"out_file": "diff_report.xlsx", "sheet_suffix1": "_old", "sheet_suffix2": "_new"}\n]'></textarea>
          <div class="helper-text">至少提供一个映射对象，用于指定输出文件名、sheet 后缀、列后缀等。缺省的 <code>out_file</code> 会自动生成。</div>
        </div>

        <div class="action-buttons">
          <button id="btnDiffHighlight" class="btn btn-warning">
            <i class="fas fa-highlighter"></i> 生成高亮差异
          </button>
          <button id="btnDiffReport" class="btn btn-danger">
            <i class="fas fa-file-excel"></i> 生成差异报告
          </button>
        </div>

        <div id="diffStatus" class="diff-status"></div>
        <ul id="diffCreatedFiles" class="created-files"></ul>
      </div>
    </div>


    <!-- 结果展示区 -->
    <div class="result-section" id="resultSection" style="display: none;">
      <div class="result-tabs">
        <button class="tab active" data-tab="preview">
          <i class="fas fa-table"></i> 数据预览
        </button>
        <button class="tab" data-tab="summary">
          <i class="fas fa-info-circle"></i> 统计信息
        </button>
      </div>

      <!-- 预览标签页 -->
      <div id="tabPreview" class="tab-content active">
        <div id="columnsArea" class="column-chips"></div>
        <div class="table-container">
          <table id="previewTable" class="data-table"></table>
        </div>
      </div>

      <!-- 概要标签页 -->
      <div id="tabSummary" class="tab-content">
        <div class="summary-grid" id="summaryCards"></div>
        <div id="summaryDetails" style="margin-top: 1rem;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/horcsv.js') }}"></script>
<script>
  // Tab切换功能
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;

      // 更新tab状态
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      // 更新内容区
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
    });
  });
</script>
{% endblock %}
