{% extends "horbase.html" %}
{% block title %}用户管理 - Horsation{% endblock %}

{% block extra_head %}
<style>
  .user-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  .user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }

  .user-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .user-info {
    display: flex;
    align-items: center;
  }

  .user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    margin-right: 15px;
  }

  .user-details h5 {
    margin: 0;
    font-weight: 600;
    color: #333;
  }

  .user-details p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
  }

  .role-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .role-horizon {
    background: linear-gradient(45deg, #ff6b6b, #ffa500);
    color: white;
  }

  .role-horizonadmin {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
  }

  .role-vip1, .role-vip2, .role-vip3 {
    background: linear-gradient(45deg, #ffd700, #ffb347);
    color: #333;
  }

  .role-user {
    background: #e9ecef;
    color: #495057;
  }

  .user-actions {
    display: flex;
    gap: 8px;
  }

  .btn-sm {
    padding: 4px 8px;
    font-size: 0.8rem;
    border-radius: 6px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
  }

  .stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 5px;
  }

  .stat-label {
    color: #666;
    font-size: 0.9rem;
  }

  .search-bar {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .modal-content {
    border-radius: 12px;
    border: none;
  }

  .modal-header {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px 12px 0 0;
  }

  .status-active {
    color: #28a745;
  }

  .status-inactive {
    color: #dc3545;
  }

  .last-login {
    font-size: 0.8rem;
    color: #999;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h2><i class="fas fa-users"></i> 用户管理</h2>
  <p class="text-muted">管理系统用户、角色和权限</p>
</div>

<!-- 统计卡片 -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-number" id="total-users">0</div>
    <div class="stat-label">总用户数</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="active-users">0</div>
    <div class="stat-label">活跃用户</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="admin-users">0</div>
    <div class="stat-label">管理员</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="vip-users">0</div>
    <div class="stat-label">VIP用户</div>
  </div>
</div>

<!-- 搜索和操作栏 -->
<div class="search-bar">
  <div class="row align-items-center">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text">
          <i class="fas fa-search"></i>
        </span>
        <input type="text"
               class="form-control"
               id="search-input"
               placeholder="搜索用户名、邮箱或显示名称...">
      </div>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="role-filter">
        <option value="">所有角色</option>
        <option value="horizon">Horizon超级管理员</option>
        <option value="horizonadmin">Horizon管理员</option>
        <option value="vip1">VIP1用户</option>
        <option value="vip2">VIP2用户</option>
        <option value="vip3">VIP3用户</option>
        <option value="user">普通用户</option>
      </select>
    </div>
    <div class="col-md-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="fas fa-plus"></i> 添加用户
      </button>
    </div>
  </div>
</div>

<!-- 用户列表 -->
<div id="users-container">
  <!-- 用户卡片将在这里动态生成 -->
</div>

<!-- 加载提示 -->
<div id="loading" class="text-center" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-2">加载中...</p>
</div>

<!-- 添加用户模态框 -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-plus"></i> 添加新用户
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="add-user-form">
          <div class="mb-3">
            <label for="new-username" class="form-label">用户名</label>
            <input type="text" class="form-control" id="new-username" required>
          </div>
          <div class="mb-3">
            <label for="new-password" class="form-label">密码</label>
            <input type="password" class="form-control" id="new-password" required minlength="6">
            <div class="form-text">密码至少6位字符</div>
          </div>
          <div class="mb-3">
            <label for="new-display-name" class="form-label">显示名称</label>
            <input type="text" class="form-control" id="new-display-name">
          </div>
          <div class="mb-3">
            <label for="new-email" class="form-label">邮箱</label>
            <input type="email" class="form-control" id="new-email">
          </div>
          <div class="mb-3">
            <label for="new-role" class="form-label">角色</label>
            <select class="form-select" id="new-role" required>
              <option value="user">普通用户</option>
              <option value="vip3">VIP3用户</option>
              <option value="vip2">VIP2用户</option>
              <option value="vip1">VIP1用户</option>
              <option value="horizonadmin">Horizon管理员</option>
              <option value="horizon">Horizon超级管理员</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="create-user-btn">创建用户</button>
      </div>
    </div>
  </div>
</div>

<!-- 编辑用户模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-edit"></i> 编辑用户
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="edit-user-form">
          <input type="hidden" id="edit-username">
          <div class="mb-3">
            <label for="edit-role" class="form-label">角色</label>
            <select class="form-select" id="edit-role" required>
              <option value="user">普通用户</option>
              <option value="vip3">VIP3用户</option>
              <option value="vip2">VIP2用户</option>
              <option value="vip1">VIP1用户</option>
              <option value="horizonadmin">Horizon管理员</option>
              <option value="horizon">Horizon超级管理员</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">状态</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="edit-is-active">
              <label class="form-check-label" for="edit-is-active">
                账户激活
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="update-user-btn">更新用户</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
(() => {
  const $ = (id) => document.getElementById(id);
  let allUsers = [];
  let filteredUsers = [];

  // 初始化
  document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    setupEventListeners();
  });

  // 设置事件监听器
  function setupEventListeners() {
    // 搜索和过滤
    $('search-input').addEventListener('input', filterUsers);
    $('role-filter').addEventListener('change', filterUsers);

    // 创建用户
    $('create-user-btn').addEventListener('click', createUser);

    // 更新用户
    $('update-user-btn').addEventListener('click', updateUser);
  }

  // 加载用户列表
  async function loadUsers() {
    try {
      showLoading(true);

      const response = await fetch('/api/auth/users');
      const data = await response.json();

      if (data.ok) {
        allUsers = data.users;
        filteredUsers = allUsers;
        renderUsers();
        updateStats();
      } else {
        showAlert(data.error, 'danger');
      }
    } catch (error) {
      console.error('Load users error:', error);
      showAlert('加载用户列表失败', 'danger');
    } finally {
      showLoading(false);
    }
  }

  // 渲染用户列表
  function renderUsers() {
    const container = $('users-container');

    if (filteredUsers.length === 0) {
      container.innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-users fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">没有找到用户</h5>
        </div>
      `;
      return;
    }

    container.innerHTML = filteredUsers.map(user => `
      <div class="user-card">
        <div class="user-header">
          <div class="user-info">
            <div class="user-avatar">
              ${user.display_name.charAt(0).toUpperCase()}
            </div>
            <div class="user-details">
              <h5>${user.display_name}</h5>
              <p>@${user.username} ${user.email ? '• ' + user.email : ''}</p>
              <div class="last-login">
                ${user.last_login ? '最后登录: ' + formatDate(user.last_login) : '从未登录'}
              </div>
            </div>
          </div>
          <div class="d-flex align-items-center gap-3">
            <span class="role-badge role-${user.role}">
              ${user.role_info.name}
            </span>
            <i class="fas fa-circle ${user.is_active ? 'status-active' : 'status-inactive'}"
               title="${user.is_active ? '活跃' : '停用'}"></i>
            <div class="user-actions">
              <button class="btn btn-outline-primary btn-sm"
                      onclick="editUser('${user.username}')">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="user-sectors">
          <small class="text-muted">
            <i class="fas fa-key"></i> 权限: ${user.role_info.permissions.join(', ')}
          </small>
          <br>
          <small class="text-muted">
            <i class="fas fa-layer-group"></i> Sectors: ${user.role_info.sectors.join(', ')}
          </small>
        </div>
      </div>
    `).join('');
  }

  // 过滤用户
  function filterUsers() {
    const searchQuery = $('search-input').value.toLowerCase();
    const roleFilter = $('role-filter').value;

    filteredUsers = allUsers.filter(user => {
      const matchesSearch = !searchQuery ||
        user.username.toLowerCase().includes(searchQuery) ||
        user.display_name.toLowerCase().includes(searchQuery) ||
        (user.email && user.email.toLowerCase().includes(searchQuery));

      const matchesRole = !roleFilter || user.role === roleFilter;

      return matchesSearch && matchesRole;
    });

    renderUsers();
  }

  // 更新统计信息
  function updateStats() {
    const totalUsers = allUsers.length;
    const activeUsers = allUsers.filter(u => u.is_active).length;
    const adminUsers = allUsers.filter(u => u.role === 'horizon' || u.role === 'horizonadmin').length;
    const vipUsers = allUsers.filter(u => u.role.startsWith('vip')).length;

    $('total-users').textContent = totalUsers;
    $('active-users').textContent = activeUsers;
    $('admin-users').textContent = adminUsers;
    $('vip-users').textContent = vipUsers;
  }

  // 创建用户
  async function createUser() {
    try {
      const username = $('new-username').value.trim();
      const password = $('new-password').value;
      const displayName = $('new-display-name').value.trim();
      const email = $('new-email').value.trim();
      const role = $('new-role').value;

      if (!username || !password || !role) {
        showAlert('请填写必填字段', 'warning');
        return;
      }

      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username,
          password,
          display_name: displayName,
          email,
          role
        })
      });

      const data = await response.json();

      if (data.ok) {
        showAlert(data.message, 'success');
        bootstrap.Modal.getInstance($('addUserModal')).hide();
        $('add-user-form').reset();
        loadUsers();
      } else {
        showAlert(data.error, 'danger');
      }
    } catch (error) {
      console.error('Create user error:', error);
      showAlert('创建用户失败', 'danger');
    }
  }

  // 编辑用户
  window.editUser = function(username) {
    const user = allUsers.find(u => u.username === username);
    if (!user) return;

    $('edit-username').value = user.username;
    $('edit-role').value = user.role;
    $('edit-is-active').checked = user.is_active;

    new bootstrap.Modal($('editUserModal')).show();
  };

  // 更新用户
  async function updateUser() {
    try {
      const username = $('edit-username').value;
      const role = $('edit-role').value;
      const isActive = $('edit-is-active').checked;

      // 更新角色
      const roleResponse = await fetch(`/api/auth/users/${username}/role`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ role })
      });

      // 更新状态
      const statusResponse = await fetch(`/api/auth/users/${username}/status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ is_active: isActive })
      });

      const roleData = await roleResponse.json();
      const statusData = await statusResponse.json();

      if (roleData.ok && statusData.ok) {
        showAlert('用户更新成功', 'success');
        bootstrap.Modal.getInstance($('editUserModal')).hide();
        loadUsers();
      } else {
        showAlert(roleData.error || statusData.error, 'danger');
      }
    } catch (error) {
      console.error('Update user error:', error);
      showAlert('更新用户失败', 'danger');
    }
  }

  // 显示加载状态
  function showLoading(show) {
    $('loading').style.display = show ? 'block' : 'none';
    $('users-container').style.display = show ? 'none' : 'block';
  }

  // 显示消息
  function showAlert(message, type = 'info') {
    // 创建临时消息显示
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.content');
    container.insertBefore(alertDiv, container.firstChild);

    // 3秒后自动消失
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 3000);
  }

  // 格式化日期
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
  }
})();
</script>
{% endblock %}